<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©è¯»ç¥å™¨ - è¯¾å ‚éŸ³é‡ç›‘æµ‹å·¥å…·</title>
    <!-- SheetJSåº“ç”¨äºç”ŸæˆExcelæ–‡ä»¶ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* æ—©è¯»æ¨¡å¼é¢œè‰² */
            --morning-bg: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            --morning-card: rgba(255, 255, 255, 0.4);
            --morning-accent: #ff6b9d;
            
            /* è‡ªä¹ æ¨¡å¼é¢œè‰² */
            --selfstudy-bg: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --selfstudy-card: rgba(255, 255, 255, 0.4);
            --selfstudy-accent: #4facfe;
            
            /* é€šç”¨é¢œè‰² */
            --text-dark: #2d3436;
            --text-light: #636e72;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #e84393;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', 'PingFang SC', Arial, sans-serif;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
            overflow-x: hidden;
        }

        /* æ—©è¯»æ¨¡å¼èƒŒæ™¯ */
        body.mode-morning {
            background: var(--morning-bg);
        }

        /* è‡ªä¹ æ¨¡å¼èƒŒæ™¯ */
        body.mode-selfstudy {
            background: var(--selfstudy-bg);
        }

        /* è£…é¥°æ˜Ÿæ˜Ÿ */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
            animation: twinkle 3s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow);
            color: white;
        }

        .mode-btn.morning {
            background: linear-gradient(135deg, #ff6b9d, #ff8fab);
        }

        .mode-btn.selfstudy {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .mode-btn.active {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e84393, #fd79a8);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* ç»ç’ƒæ€å¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 8px 32px var(--shadow);
        }

        /* éŸ³é‡å¯è§†åŒ–åœ†å½¢ */
        .volume-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .volume-circle-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 20px;
        }

        .volume-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .volume-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            opacity: 0.3;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }

        /* éŸ³é‡ç­‰çº§æ ·å¼ */
        .volume-circle.level-seed {
            background: linear-gradient(135deg, #a8e6cf, #dcedc1);
            width: 150px;
            height: 150px;
        }

        .volume-circle.level-sprout {
            background: linear-gradient(135deg, #84fab0, #8fd3f4);
            width: 200px;
            height: 200px;
        }

        .volume-circle.level-tree {
            background: linear-gradient(135deg, #00b894, #00cec9);
            width: 250px;
            height: 250px;
        }

        .volume-circle.level-star {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            width: 300px;
            height: 300px;
            animation: starGlow 1s ease-in-out infinite;
        }

        @keyframes starGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(253, 203, 110, 0.5); }
            50% { box-shadow: 0 0 40px rgba(253, 203, 110, 0.8); }
        }

        .volume-circle.level-champion {
            background: linear-gradient(135deg, #ff6b9d, #c44569, #f8b500, #00b894);
            width: 350px;
            height: 350px;
            animation: championRotate 3s linear infinite;
            background-size: 400% 400%;
        }

        @keyframes championRotate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .volume-circle-content {
            position: relative;
            z-index: 2;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .volume-level-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .volume-level-name {
            font-size: 24px;
        }

        .volume-db {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            color: var(--text-dark);
        }

        /* çŠ¶æ€æç¤º */
        .status-message {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-message.success {
            background: rgba(0, 184, 148, 0.2);
            color: #00b894;
        }

        .status-message.warning {
            background: rgba(253, 203, 110, 0.2);
            color: #e17055;
        }

        .status-message.danger {
            background: rgba(232, 67, 147, 0.2);
            color: #e84393;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--text-dark);
        }

        /* é˜ˆå€¼è®¾ç½® */
        .threshold-section {
            margin-top: 30px;
        }

        .threshold-label {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .threshold-value {
            font-size: 24px;
            color: var(--danger);
        }

        .threshold-slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.5);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .threshold-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* æ³¢å½¢å›¾ */
        .wave-container {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        #waveCanvas {
            width: 100%;
            height: 150px;
            border-radius: 10px;
        }

        /* ä¼šè¯è®°å½• */
        .logs-section {
            margin-top: 30px;
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            overflow: hidden;
        }

        .logs-table th {
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: var(--text-dark);
        }

        .logs-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--text-dark);
        }

        .logs-table tr:last-child td {
            border-bottom: none;
        }

        /* éšè—éº¦å…‹é£é€‰æ‹©ï¼ˆç®€åŒ–æ“ä½œï¼‰ */
        .mic-selector {
            display: none;
        }

        /* æç¤ºä¿¡æ¯ */
        .hint {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 10px;
            text-align: center;
        }

        /* å¿«æ·é”®æç¤º */
        .shortcuts-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 15px;
            font-size: 12px;
            color: var(--text-dark);
            box-shadow: 0 4px 15px var(--shadow);
        }

        .shortcuts-hint h4 {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .shortcuts-hint ul {
            list-style: none;
            padding: 0;
        }

        .shortcuts-hint li {
            margin: 5px 0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .volume-circle-container {
                width: 250px;
                height: 250px;
            }

            .volume-circle.level-champion {
                width: 250px;
                height: 250px;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="mode-morning">
    <!-- è£…é¥°æ˜Ÿæ˜Ÿ -->
    <div class="stars" id="stars"></div>

    <div class="container">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="toolbar">
            <div class="mode-selector">
                <button class="mode-btn morning active" id="morningBtn">ğŸ“š æ—©è¯»æ¨¡å¼</button>
                <button class="mode-btn selfstudy" id="selfstudyBtn">ğŸ¤« è‡ªä¹ æ¨¡å¼</button>
            </div>
            <div class="toolbar-right">
                <button class="btn btn-primary" id="startBtn">â–¶ï¸ å¼€å§‹ç›‘æµ‹</button>
                <button class="btn btn-danger" id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>
                <button class="btn btn-secondary" id="fullscreenBtn">ğŸ”² å…¨å±</button>
                <button class="btn btn-secondary" id="exportBtn">ğŸ“Š å¯¼å‡ºExcel</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¦ä¾§ï¼šéŸ³é‡å¯è§†åŒ– -->
            <div class="glass-card">
                <div class="volume-display">
                    <div class="volume-circle-container">
                        <div class="volume-circle level-seed" id="volumeCircle">
                            <div class="volume-circle-content">
                                <div class="volume-level-icon" id="levelIcon">ğŸŒ±</div>
                                <div class="volume-level-name" id="levelName">ç§å­</div>
                            </div>
                        </div>
                    </div>
                    <div class="volume-db" id="dbDisplay">0 dB</div>
                    <div class="status-message success" id="statusMessage" style="display: none;">
                        ğŸ‘ å£°éŸ³å¾ˆæ£’ï¼
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ç´¯è®¡ç”¨æ—¶</div>
                        <div class="stat-value" id="elapsedTime">0:00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ—è¯»çŠ¶æ€</div>
                        <div class="stat-value" id="readingStatus">æœªå¼€å§‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ—è¯»å æ¯”</div>
                        <div class="stat-value" id="readingRatio">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¹³å‡åˆ†è´</div>
                        <div class="stat-value" id="avgDb">0</div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè®¾ç½®å’Œæ•°æ® -->
            <div class="glass-card">
                <h2 style="margin-bottom: 20px; color: var(--text-dark);">è®¾ç½®</h2>
                
                <div class="threshold-section">
                    <div class="threshold-label">
                        <span>éŸ³é‡é˜ˆå€¼</span>
                        <span class="threshold-value" id="thresholdValue">60 dB</span>
                    </div>
                    <input type="range" id="thresholdSlider" class="threshold-slider" 
                           min="30" max="100" value="60" step="1">
                    <div class="hint" id="thresholdHint">æ—©è¯»æ¨¡å¼ï¼šè¦æ±‚éŸ³é‡é«˜äºæ­¤å€¼</div>
                </div>

                <div class="wave-container">
                    <canvas id="waveCanvas"></canvas>
                </div>

                <div class="hint">
                    æç¤ºï¼šä¿æŒæµè§ˆå™¨å‰å°è¿è¡Œï¼›ç§»åŠ¨ç«¯æµè§ˆå™¨é”å±ä¼šæš‚åœéŸ³é¢‘å¤„ç†ã€‚
                </div>
            </div>
        </div>

        <!-- ä¼šè¯è®°å½• -->
        <div class="glass-card logs-section">
            <h2 style="margin-bottom: 20px; color: var(--text-dark);">ä¼šè¯è®°å½•</h2>
            <table class="logs-table">
                <thead>
                    <tr>
                        <th>å¼€å§‹æ—¶é—´</th>
                        <th>æ¨¡å¼</th>
                        <th>æ—¶é•¿</th>
                        <th>æœ—è¯»å æ¯”</th>
                        <th>å¹³å‡åˆ†è´</th>
                        <th>æœ€é«˜åˆ†è´</th>
                        <th>æœ€ä½åˆ†è´</th>
                    </tr>
                </thead>
                <tbody id="logsBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--text-light);">
                            æš‚æ— è®°å½•
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- å¿«æ·é”®æç¤º -->
    <div class="shortcuts-hint">
        <h4>âŒ¨ï¸ å¿«æ·é”®</h4>
        <ul>
            <li>ç©ºæ ¼é”®ï¼šå¼€å§‹/åœæ­¢</li>
            <li>Fé”®ï¼šå…¨å±</li>
            <li>Mé”®ï¼šåˆ‡æ¢æ¨¡å¼</li>
        </ul>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentMode = 'morning'; // 'morning' æˆ– 'selfstudy'
        let audioCtx, analyser, mediaStream, sourceNode, rafId;
        let startedAt = 0;
        let timerId = null;
        let frames = 0;
        let rmsSum = 0;
        let readingFrames = 0;
        let maxDb = 0;
        let minDb = 100;
        let currentDb = 0;
        let thresholdDb = 60; // é»˜è®¤é˜ˆå€¼ï¼ˆåˆ†è´ï¼‰
        let sessionLogs = [];
        let isRunning = false;

        // DOMå…ƒç´ 
        const morningBtn = document.getElementById('morningBtn');
        const selfstudyBtn = document.getElementById('selfstudyBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const exportBtn = document.getElementById('exportBtn');
        const volumeCircle = document.getElementById('volumeCircle');
        const levelIcon = document.getElementById('levelIcon');
        const levelName = document.getElementById('levelName');
        const dbDisplay = document.getElementById('dbDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const elapsedTime = document.getElementById('elapsedTime');
        const readingStatus = document.getElementById('readingStatus');
        const readingRatio = document.getElementById('readingRatio');
        const avgDb = document.getElementById('avgDb');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValue = document.getElementById('thresholdValue');
        const thresholdHint = document.getElementById('thresholdHint');
        const waveCanvas = document.getElementById('waveCanvas');
        const waveCtx = waveCanvas.getContext('2d');
        const logsBody = document.getElementById('logsBody');

        // éŸ³é‡ç­‰çº§é…ç½®
        const volumeLevels = [
            { name: 'ç§å­', icon: 'ğŸŒ±', min: 0, max: 40, class: 'level-seed' },
            { name: 'å°è‹—', icon: 'ğŸŒ¿', min: 40, max: 60, class: 'level-sprout' },
            { name: 'å¤§æ ‘', icon: 'ğŸŒ³', min: 60, max: 80, class: 'level-tree' },
            { name: 'æ˜Ÿæ˜Ÿ', icon: 'â­', min: 80, max: 100, class: 'level-star' },
            { name: 'å† å†›', icon: 'ğŸ†', min: 100, max: 200, class: 'level-champion' }
        ];

        // åˆå§‹åŒ–
        function init() {
            // åŠ è½½ä¿å­˜çš„è®¾ç½®
            loadSettings();
            
            // åˆ›å»ºè£…é¥°æ˜Ÿæ˜Ÿ
            createStars();
            
            // åˆå§‹åŒ–ç”»å¸ƒ
            resizeCanvas();
            
            // ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // æ›´æ–°ç•Œé¢
            updateModeUI();
        }

        // åˆ›å»ºè£…é¥°æ˜Ÿæ˜Ÿ
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 30;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.textContent = 'âœ¨';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                starsContainer.appendChild(star);
            }
        }

        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            waveCanvas.width = waveCanvas.clientWidth * dpr;
            waveCanvas.height = waveCanvas.clientHeight * dpr;
            waveCtx.scale(dpr, dpr);
        }

        window.addEventListener('resize', resizeCanvas);

        // åŠ è½½è®¾ç½®
        function loadSettings() {
            const savedMode = localStorage.getItem('readingMode');
            const savedThreshold = localStorage.getItem('readingThreshold');
            
            if (savedMode) {
                currentMode = savedMode;
            }
            
            if (savedThreshold) {
                thresholdDb = parseInt(savedThreshold);
                thresholdSlider.value = thresholdDb;
            } else {
                // æ ¹æ®æ¨¡å¼è®¾ç½®é»˜è®¤é˜ˆå€¼
                thresholdDb = currentMode === 'morning' ? 60 : 40;
                thresholdSlider.value = thresholdDb;
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            localStorage.setItem('readingMode', currentMode);
            localStorage.setItem('readingThreshold', thresholdDb.toString());
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ¨¡å¼åˆ‡æ¢
            morningBtn.addEventListener('click', () => switchMode('morning'));
            selfstudyBtn.addEventListener('click', () => switchMode('selfstudy'));

            // å¼€å§‹/åœæ­¢
            startBtn.addEventListener('click', startMonitoring);
            stopBtn.addEventListener('click', stopMonitoring);

            // å…¨å±
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            // å¯¼å‡º
            exportBtn.addEventListener('click', exportData);

            // é˜ˆå€¼æ»‘å—
            thresholdSlider.addEventListener('input', (e) => {
                thresholdDb = parseInt(e.target.value);
                thresholdValue.textContent = thresholdDb + ' dB';
                saveSettings();
            });

            // å¿«æ·é”®
            document.addEventListener('keydown', handleKeyboard);
        }

        // åˆ‡æ¢æ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            morningBtn.classList.toggle('active', mode === 'morning');
            selfstudyBtn.classList.toggle('active', mode === 'selfstudy');
            
            // æ›´æ–°èƒŒæ™¯
            document.body.className = `mode-${mode}`;
            
            // æ›´æ–°é»˜è®¤é˜ˆå€¼
            if (mode === 'morning') {
                thresholdDb = 60;
            } else {
                thresholdDb = 40;
            }
            thresholdSlider.value = thresholdDb;
            thresholdValue.textContent = thresholdDb + ' dB';
            
            // æ›´æ–°æç¤º
            updateModeUI();
            
            // ä¿å­˜è®¾ç½®
            saveSettings();
        }

        // æ›´æ–°æ¨¡å¼UI
        function updateModeUI() {
            if (currentMode === 'morning') {
                thresholdHint.textContent = 'æ—©è¯»æ¨¡å¼ï¼šè¦æ±‚éŸ³é‡é«˜äºæ­¤å€¼';
            } else {
                thresholdHint.textContent = 'è‡ªä¹ æ¨¡å¼ï¼šè¦æ±‚éŸ³é‡ä½äºæ­¤å€¼';
            }
        }

        // å¼€å§‹ç›‘æµ‹
        async function startMonitoring() {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        channelCount: 1,
                        sampleRate: 48000
                    }
                });

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                sourceNode = audioCtx.createMediaStreamSource(mediaStream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                sourceNode.connect(analyser);

                // é‡ç½®ç»Ÿè®¡æ•°æ®
                startedAt = Date.now();
                frames = 0;
                rmsSum = 0;
                readingFrames = 0;
                maxDb = 0;
                minDb = 100;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                startBtn.disabled = true;
                stopBtn.disabled = false;
                isRunning = true;

                // å¼€å§‹åˆ†æå¾ªç¯
                analyseLoop();

                // å¼€å§‹è®¡æ—¶å™¨
                timerId = setInterval(() => {
                    updateElapsedTime();
                }, 1000);

            } catch (err) {
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼š' + err.message);
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }

        // åœæ­¢ç›‘æµ‹
        function stopMonitoring() {
            isRunning = false;
            
            // åœæ­¢åŠ¨ç”»å¾ªç¯
            if (rafId) {
                cancelAnimationFrame(rafId);
            }
            
            // åœæ­¢è®¡æ—¶å™¨
            if (timerId) {
                clearInterval(timerId);
            }
            
            // å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (audioCtx) {
                audioCtx.close();
            }
            
            // åœæ­¢åª’ä½“æµ
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // ä¿å­˜ä¼šè¯è®°å½•
            saveSessionLog();
            
            // é‡ç½®æ˜¾ç¤º
            resetDisplay();
        }

        // åˆ†æå¾ªç¯
        function analyseLoop() {
            if (!isRunning) return;

            const buf = new Uint8Array(analyser.fftSize);
            analyser.getByteTimeDomainData(buf);
            
            // ç»˜åˆ¶æ³¢å½¢
            drawWave(buf);
            
            // è®¡ç®—RMS
            let sum = 0;
            for (let i = 0; i < buf.length; i++) {
                const v = (buf[i] - 128) / 128;
                sum += v * v;
            }
            const rms = Math.sqrt(sum / buf.length) || 1e-8;
            
            // è½¬æ¢ä¸ºåˆ†è´å€¼
            const db = Math.max(0, Math.min(120, 20 * Math.log10(rms) + 100));
            currentDb = db;
            
            // æ›´æ–°ç»Ÿè®¡
            frames++;
            rmsSum += db;
            maxDb = Math.max(maxDb, db);
            minDb = Math.min(minDb, db);
            
            // åˆ¤æ–­æ˜¯å¦åœ¨è¯»
            const isReading = currentMode === 'morning' 
                ? db >= thresholdDb 
                : db <= thresholdDb;
            
            if (isReading) {
                readingFrames++;
            }
            
            // æ›´æ–°ç•Œé¢
            updateVolumeDisplay(db);
            updateVolumeLevel(db);
            updateStatusMessage(db, isReading);
            updateStats();
            
            // ç»§ç»­å¾ªç¯
            rafId = requestAnimationFrame(analyseLoop);
        }

        // ç»˜åˆ¶æ³¢å½¢
        function drawWave(buf) {
            const w = waveCanvas.clientWidth;
            const h = waveCanvas.clientHeight;
            
            waveCtx.clearRect(0, 0, w, h);
            
            // ç»˜åˆ¶èƒŒæ™¯
            waveCtx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            waveCtx.fillRect(0, 0, w, h);
            
            // ç»˜åˆ¶æ³¢å½¢
            waveCtx.strokeStyle = currentMode === 'morning' ? '#ff6b9d' : '#4facfe';
            waveCtx.lineWidth = 2;
            waveCtx.beginPath();
            
            const step = Math.ceil(buf.length / w);
            for (let x = 0, i = 0; x < w; x++, i += step) {
                const v = (buf[i] - 128) / 128;
                const y = h / 2 + v * (h * 0.4);
                if (x === 0) {
                    waveCtx.moveTo(x, y);
                } else {
                    waveCtx.lineTo(x, y);
                }
            }
            
            waveCtx.stroke();
        }

        // æ›´æ–°éŸ³é‡æ˜¾ç¤º
        function updateVolumeDisplay(db) {
            dbDisplay.textContent = db.toFixed(1) + ' dB';
        }

        // æ›´æ–°éŸ³é‡ç­‰çº§
        function updateVolumeLevel(db) {
            let level = volumeLevels[0];
            for (let i = volumeLevels.length - 1; i >= 0; i--) {
                if (db >= volumeLevels[i].min) {
                    level = volumeLevels[i];
                    break;
                }
            }
            
            // æ›´æ–°å›¾æ ‡å’Œåç§°
            levelIcon.textContent = level.icon;
            levelName.textContent = level.name;
            
            // æ›´æ–°åœ†å½¢æ ·å¼
            volumeCircle.className = 'volume-circle ' + level.class;
            
            // æ ¹æ®éŸ³é‡è°ƒæ•´å¤§å°
            const scale = Math.min(1, (db - level.min) / (level.max - level.min) + 0.5);
            const size = level === volumeLevels[0] ? 150 : 
                         level === volumeLevels[1] ? 200 : 
                         level === volumeLevels[2] ? 250 : 
                         level === volumeLevels[3] ? 300 : 350;
            volumeCircle.style.width = size + 'px';
            volumeCircle.style.height = size + 'px';
        }

        // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
        function updateStatusMessage(db, isReading) {
            if (!isRunning) {
                statusMessage.style.display = 'none';
                return;
            }
            
            statusMessage.style.display = 'block';
            
            if (currentMode === 'morning') {
                if (isReading) {
                    statusMessage.className = 'status-message success';
                    statusMessage.textContent = 'ğŸ‘ å£°éŸ³å¾ˆæ£’ï¼';
                } else {
                    statusMessage.className = 'status-message warning';
                    statusMessage.textContent = 'ğŸ”Š å£°éŸ³å†å¤§ä¸€ç‚¹å“¦ï¼';
                }
            } else {
                if (isReading) {
                    statusMessage.className = 'status-message success';
                    statusMessage.textContent = 'âœ… ä¿æŒå®‰é™';
                } else {
                    statusMessage.className = 'status-message danger';
                    statusMessage.textContent = 'âš ï¸ éŸ³é‡è¿‡å¤§ï¼Œè¯·ä¿æŒå®‰é™ï¼';
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            // æœ—è¯»å æ¯”
            const ratio = frames > 0 ? (readingFrames / frames * 100).toFixed(1) : 0;
            readingRatio.textContent = ratio + '%';
            
            // å¹³å‡åˆ†è´
            const avg = frames > 0 ? (rmsSum / frames).toFixed(1) : 0;
            avgDb.textContent = avg;
            
            // æœ—è¯»çŠ¶æ€
            const isReading = currentMode === 'morning' 
                ? currentDb >= thresholdDb 
                : currentDb <= thresholdDb;
            readingStatus.textContent = isReading ? 'åœ¨è¯»' : 'æœªè¯»';
            readingStatus.style.color = isReading ? '#00b894' : '#e17055';
        }

        // æ›´æ–°ç”¨æ—¶
        function updateElapsedTime() {
            if (!isRunning) return;
            const elapsed = Date.now() - startedAt;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            elapsedTime.textContent = `${minutes}:${String(secs).padStart(2, '0')}`;
        }

        // é‡ç½®æ˜¾ç¤º
        function resetDisplay() {
            volumeCircle.className = 'volume-circle level-seed';
            volumeCircle.style.width = '150px';
            volumeCircle.style.height = '150px';
            levelIcon.textContent = 'ğŸŒ±';
            levelName.textContent = 'ç§å­';
            dbDisplay.textContent = '0 dB';
            statusMessage.style.display = 'none';
            elapsedTime.textContent = '0:00';
            readingStatus.textContent = 'æœªå¼€å§‹';
            readingRatio.textContent = '0%';
            avgDb.textContent = '0';
            
            // æ¸…ç©ºç”»å¸ƒ
            waveCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
        }

        // ä¿å­˜ä¼šè¯è®°å½•
        function saveSessionLog() {
            if (frames === 0) return;
            
            const duration = Math.floor((Date.now() - startedAt) / 1000);
            const ratio = (readingFrames / frames * 100).toFixed(1);
            const avg = (rmsSum / frames).toFixed(1);
            
            const log = {
                time: new Date().toLocaleString('zh-CN'),
                mode: currentMode === 'morning' ? 'æ—©è¯»' : 'è‡ªä¹ ',
                duration: duration,
                ratio: ratio,
                avgDb: avg,
                maxDb: maxDb.toFixed(1),
                minDb: minDb.toFixed(1)
            };
            
            sessionLogs.push(log);
            renderLogs();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('readingLogs', JSON.stringify(sessionLogs));
        }

        // æ¸²æŸ“æ—¥å¿—
        function renderLogs() {
            if (sessionLogs.length === 0) {
                logsBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--text-light);">
                            æš‚æ— è®°å½•
                        </td>
                    </tr>
                `;
                return;
            }
            
            logsBody.innerHTML = sessionLogs.map(log => `
                <tr>
                    <td>${log.time}</td>
                    <td>${log.mode}</td>
                    <td>${log.duration}ç§’</td>
                    <td>${log.ratio}%</td>
                    <td>${log.avgDb} dB</td>
                    <td>${log.maxDb} dB</td>
                    <td>${log.minDb} dB</td>
                </tr>
            `).join('');
        }

        // å¯¼å‡ºæ•°æ®ï¼ˆExcelæ ¼å¼ï¼‰
        function exportData() {
            if (sessionLogs.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // æ£€æŸ¥SheetJSåº“æ˜¯å¦åŠ è½½
            if (typeof XLSX === 'undefined') {
                alert('Excelå¯¼å‡ºåŠŸèƒ½åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            // å‡†å¤‡æ•°æ®
            const header = ['æ—¶é—´', 'æ¨¡å¼', 'æ—¶é•¿(ç§’)', 'æœ—è¯»å æ¯”(%)', 'å¹³å‡åˆ†è´', 'æœ€é«˜åˆ†è´', 'æœ€ä½åˆ†è´'];
            const rows = sessionLogs.map(log => [
                log.time,
                log.mode,
                log.duration,
                parseFloat(log.ratio), // è½¬æ¢ä¸ºæ•°å­—
                parseFloat(log.avgDb), // è½¬æ¢ä¸ºæ•°å­—
                parseFloat(log.maxDb), // è½¬æ¢ä¸ºæ•°å­—
                parseFloat(log.minDb)  // è½¬æ¢ä¸ºæ•°å­—
            ]);
            
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // åˆ›å»ºå·¥ä½œè¡¨æ•°æ®
            const wsData = [header, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                { wch: 20 }, // æ—¶é—´åˆ—
                { wch: 8 },  // æ¨¡å¼åˆ—
                { wch: 10 }, // æ—¶é•¿åˆ—
                { wch: 12 }, // æœ—è¯»å æ¯”åˆ—
                { wch: 10 }, // å¹³å‡åˆ†è´åˆ—
                { wch: 10 }, // æœ€é«˜åˆ†è´åˆ—
                { wch: 10 }  // æœ€ä½åˆ†è´åˆ—
            ];
            
            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'æ—©è¯»è®°å½•');
            
            // ç”Ÿæˆæ–‡ä»¶å
            const fileName = `æ—©è¯»è®°å½•_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // å¯¼å‡ºExcelæ–‡ä»¶
            XLSX.writeFile(wb, fileName);
        }

        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼', err);
                });
                fullscreenBtn.textContent = 'ğŸ”³ é€€å‡ºå…¨å±';
            } else {
                document.exitFullscreen();
                fullscreenBtn.textContent = 'ğŸ”² å…¨å±';
            }
        }

        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyboard(e) {
            // ç©ºæ ¼é”®ï¼šå¼€å§‹/åœæ­¢
            if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (isRunning) {
                    stopMonitoring();
                } else {
                    startMonitoring();
                }
            }
            
            // Fé”®ï¼šå…¨å±
            if (e.code === 'KeyF' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                toggleFullscreen();
            }
            
            // Mé”®ï¼šåˆ‡æ¢æ¨¡å¼
            if (e.code === 'KeyM' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                switchMode(currentMode === 'morning' ? 'selfstudy' : 'morning');
            }
        }

        // åŠ è½½å†å²è®°å½•
        function loadLogs() {
            const saved = localStorage.getItem('readingLogs');
            if (saved) {
                try {
                    sessionLogs = JSON.parse(saved);
                    renderLogs();
                } catch (e) {
                    console.error('åŠ è½½è®°å½•å¤±è´¥', e);
                }
            }
        }

        // ç›‘å¬å…¨å±å˜åŒ–
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                fullscreenBtn.textContent = 'ğŸ”³ é€€å‡ºå…¨å±';
            } else {
                fullscreenBtn.textContent = 'ğŸ”² å…¨å±';
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            init();
            loadLogs();
        });
    </script>
</body>
</html>

